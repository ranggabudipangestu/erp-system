sequenceDiagram
    participant U as User
    participant FE as Frontend
    participant API as FastAPI
    participant PS as PasswordService
    parameter ES as EmailService
    participant Cache as Redis
    participant DB as Database

    U->>FE: Enter email for reset
    FE->>API: POST /api/auth/password/forgot
    
    activate API
    API->>PS: initiate_password_reset(email)
    
    activate PS
    PS->>DB: Find user by email
    alt User exists
        PS->>PS: Generate secure token
        PS->>Cache: Store token (15min TTL)
        PS->>ES: Send reset email
        PS-->>API: Success (always success for security)
    else User not found
        PS-->>API: Success (don't reveal if email exists)
    end
    deactivate PS
    
    API-->>FE: 200 OK
    FE->>U: Check email message
    deactivate API
    
    Note over ES,U: Email sent with reset link
    
    U->>FE: Click reset link
    FE->>API: GET /api/auth/password/reset/{token}
    API->>PS: validate_reset_token(token)
    PS->>Cache: Check token exists & not expired
    PS-->>API: Token validation result
    API-->>FE: Token status
    
    alt Token valid
        U->>FE: Enter new password
        FE->>API: POST /api/auth/password/reset
        API->>PS: reset_password(token, new_password)
        
        activate PS
        PS->>Cache: Get & delete token
        PS->>DB: Update user password
        PS->>Cache: Revoke all user sessions
        PS->>ES: Send confirmation email
        PS-->>API: Password reset success
        deactivate PS
        
        API-->>FE: 200 OK
        FE->>U: Success + redirect to login
    else Token invalid/expired
        API-->>FE: 400 Bad Request
        FE->>U: Token expired, request new reset
    end